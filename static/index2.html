<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Data Display</title>
    <link rel="stylesheet" type="text/css" href="static/format.css">
    <!-- Leaflet.js and its CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
</head>
<body>
<header>
    <div class="header-content">
        <h3>Satellite Network Data Display</h3>
        <h6>Professor Robert White Ph.D.</h6>
    </div>
    <nav>
        <ul class="nav_links">
            <li><a href="https://sites.tufts.edu/senselab/research/#anemometer">MSS Lab Site</a></li>
        </ul>
    </nav>
</header>

<!-- Map Container -->
<div id="map" style="height: 500px; margin-bottom: 20px;"></div>

<!-- Graph Container -->
<div id="graph" style="width: 100%; height: 500px;"></div>

<script>
  const BASE_URL = 'https://iridium-data-display.onrender.com'; // Flask backend address

  const map = L.map('map').setView([0, 0], 2); // Center map
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const marker = L.marker([0, 0]).addTo(map); // Initialize marker
  const flightPath = [];
  const pathLine = L.polyline(flightPath, { color: 'blue' }).addTo(map);

  // Data arrays for graph updates
  const times = [];
  const altitudes = [];

  // Function to update the graph
  function updateGraph() {
    fetch(`${BASE_URL}/history`)
      .then(response => response.json())
      .then(history => {
        // Grab the latest data for graph updates
        const latestData = history[history.length - 1];
        const time = latestData.time;
        const altitude = latestData.altitude;

        // Push new data to arrays
        times.push(time);
        altitudes.push(altitude);

        // Update the graph with new data
        const data = [{
          x: times,
          y: altitudes,
          mode: 'lines',
          name: 'Altitude'
        }];

        const layout = {
          title: 'Satellite Altitude Over Time',
          xaxis: { title: 'Time' },
          yaxis: { title: 'Altitude (m)' }
        };

        Plotly.newPlot('graph', data, layout);
      })
      .catch(error => console.error('Error updating graph:', error));
  }

  // Function to update the map and flight path
  function updateMapAndPath() {
    fetch(`${BASE_URL}/live-data`)
      .then(response => response.json())
      .then(data => {
        const { latitude, longitude, altitude, temperature, time } = data;

        if (latitude && longitude) {
          marker.setLatLng([latitude, longitude]);
          marker.bindPopup(`Satellite Location<br>Lat: ${latitude}, Long: ${longitude}<br>Alt: ${altitude}m<br>Temp: ${temperature}°C`).openPopup();

          // Append new point to flight path
          flightPath.push([latitude, longitude]);
          pathLine.setLatLngs(flightPath);
          map.fitBounds(pathLine.getBounds());
        }
      })
      .catch(error => console.error('Error updating map and path:', error));
  }

  // Load initial historical data for path
  function loadInitialPath() {
    fetch(`${BASE_URL}/history`)
      .then(response => response.json())
      .then(history => {
        history.forEach(point => {
          flightPath.push([point.latitude, point.longitude]);
        });

        pathLine.setLatLngs(flightPath);
        map.fitBounds(pathLine.getBounds());
      })
      .catch(error => console.error('Error loading initial path:', error));
  }

  // Initial data load and setup
  loadInitialPath();
  updateGraph();

  // Set intervals to update data
  setInterval(updateGraph, 10000); // Update graph every 10 seconds
  setInterval(updateMapAndPath, 10000); // Update map and path every 10 seconds
</script>
</body>
</html>

</html>



